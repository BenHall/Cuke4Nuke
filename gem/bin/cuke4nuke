require 'rubygems'
require 'systemu'
require 'win32/process'

def launch_cuke4nuke_process(step_definitions_dll_path)
  cuke4nuke_server_exe = File.expand_path(File.join(File.dirname(__FILE__), 'Cuke4Nuke.Server.exe'))
  command = %{"#{cuke4nuke_server_exe}" -a "#{step_definitions_dll_path}"}
  process = IO.popen(command, 'r')
  @cuke4nuke_server_pid = process.pid
end

def kill_cuke4nuke_process
  Process.kill(9, @cuke4nuke_server_pid)
end

def launch_cucumber(args)
  command = "cucumber #{args.join(' ')} 2>&1"
  status, stdout, stderr = systemu(command)
  puts stdout
end

if ARGV.empty? || ['-h', '-?', '/?', '--help'].include?(ARGV[0])
  puts "Usage: cuke4nuke STEP_DEFINITION_DLL_PATH [CUCUMBER_ARGUMENTS]\n\n"
  puts "The following is Cucumber's help. Anything after the cucumber command can be"
  puts "passed in the CUCUMBER_ARGUMENTS argument for cuke4nuke:\n\n"
  launch_cucumber(['--help'])
else
  args = ARGV.clone
  step_definitions_dll_path = args.shift

  launch_cuke4nuke_process(step_definitions_dll_path)

  begin
    launch_cucumber(args)
  ensure
    kill_cuke4nuke_process
  end
end